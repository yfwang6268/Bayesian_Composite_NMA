---
title: "H and J matrix under multivariate setting"
author: "Yifei Wang"
date: '2023-06-01'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## H matrix

$$
\hat{H}_{\mu\mu} = \left[\begin{array}{cccccc}
-\frac{\partial^2 \ell}{\partial\left(\mu_1^{BA}\right)^2} & 0   & 0  & 0  & 0  & 0  \\
0 & -\frac{\partial^2 \ell}{\partial\left(\mu_1^{CA}\right)^2}  & 0  & 0  & 0  & 0 \\
0  & 0  &  -\frac{\partial^2 \ell}{\partial\left(\mu_1^{BC}\right)^2} & 0 & 0 & 0 \\
0 & 0 & 0 & -\frac{\partial^2 \ell}{\partial\left(\mu_2^{BA}\right)^2} & 0 & 0  \\
0 & 0 & 0 & 0 &  -\frac{\partial^2 \ell}{\partial\left(\mu_2^{CA}\right)^2} & 0 \\
0 & 0 & 0 & 0 & 0 &  -\frac{\partial^2 \ell}{\partial\left(\mu_2^{BC}\right)^2} \\
\end{array}\right]
$$
where $\frac{\partial^2 \ell}{\partial\left(\mu_k^{XZ}\right)^2} = -\sum_{i \in N_{XZ}^k} \frac{1}{s_{k,i}^{XZ^2}+\tau_{k}^{XZ^2}}$

## J matrix

Denote

$$
\hat{S}^{XY}_i = \frac{\partial\left[ \log \left(s_{k,i}^{XY}, \tau^{XY^2}_k\right) + \frac{\left(y_{k,i}^{XY} - \mu_{k}^{XY}\right)^2}{s_{k,i}^{XY} + \tau^{XY^2}_k}\right]}{\partial \eta}
$$
where $\hat{S}^{XY}_i$ should be a matrix with dimension $1\times6$ 

J matrix would be

$$
\begin{aligned}
\hat{J}_{\mu\mu} &= \frac{1}{4} \sum_{k=1}^2\left\{\sum_{\mathrm{XY} \in\{\mathrm{AB}, \mathrm{BC}, \mathrm{AC}\}} \sum_{i \in \mathcal{N}_{\mathrm{XY}}^k} S_i^{X Y} S_i^{X Y^{\mathrm{T}}}\right\} \\
&= \mathrm{Diag}\left(\left[\sum_{i \in \mathcal{N}_{\mathrm{XY}}^k}\frac{\left(y_{k,i}^{BA}-\mu_k^{BA}\right)^2}{\left(s_{k,i}^{XY} + \tau^{XY^2}_k\right)^2}\right]\right)_{6 \times 6}
\end{aligned}
$$
where $\eta = \left[\mu_k^{XY}\right]_{1 \times 6}$ for outcome $k=1,2$ and treatment $XY \in \left\{BA, CA, BC\right\}$

## Covariance Matrix

$$
\hat{V}(\hat{\eta})=\hat{H}^{-1}_{\mu\mu} \hat{J}_{\mu\mu} \hat{H}^{-1}_{\mu\mu}
$$

## Reference

The appendix in Duan2020
